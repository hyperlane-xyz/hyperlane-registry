name: Update Hyperlane Dependencies

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual triggering

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Generate GitHub App Token
        id: generate-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.HYPER_GONK_APP_ID }}
          private-key: ${{ secrets.HYPER_GONK_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ steps.generate-token.outputs.token }}

      - name: Configure Git
        run: |
          git config user.name "${{ steps.generate-token.outputs.app-slug }}[bot]"
          git config user.email "${{ secrets.HYPER_GONK_APP_ID }}+${{ steps.generate-token.outputs.app-slug }}[bot]@users.noreply.github.com"

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Get latest SDK and Utils versions
        id: get-versions
        run: |
          LATEST_SDK=$(yarn npm info @hyperlane-xyz/sdk --fields version --json | jq -r '.version')
          LATEST_UTILS=$(yarn npm info @hyperlane-xyz/utils --fields version --json | jq -r '.version')
          echo "sdk=$LATEST_SDK" >> $GITHUB_OUTPUT
          echo "utils=$LATEST_UTILS" >> $GITHUB_OUTPUT
          echo "Latest SDK: $LATEST_SDK"
          echo "Latest Utils: $LATEST_UTILS"

      - name: Update package.json with latest versions
        run: |
          npm pkg set devDependencies.@hyperlane-xyz/sdk=${{ steps.get-versions.outputs.sdk }}
          npm pkg set devDependencies.@hyperlane-xyz/utils=${{ steps.get-versions.outputs.utils }}

      - name: Install dependencies
        run: yarn install --no-immutable

      - name: Run build
        id: build
        continue-on-error: true
        run: yarn build

      - name: Run tests
        id: test
        continue-on-error: true
        run: yarn test:unit

      - name: Create changeset
        run: |
          # Generate a unique changeset filename using timestamp
          CHANGESET_FILE=".changeset/auto-update-hyperlane-deps-$(date +%s).md"
          cat << 'EOF' > "$CHANGESET_FILE"
          ---
          "@hyperlane-xyz/registry": minor
          ---

          Update Hyperlane dependencies to SDK ${{ steps.get-versions.outputs.sdk }} and Utils ${{ steps.get-versions.outputs.utils }}
          EOF
          echo "Created changeset: $CHANGESET_FILE"

      - name: Check for changes and create PR
        if: always()
        env:
          GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          if ! git diff --quiet; then
            git checkout -b ci/update-hl-deps
            git add -A
            git commit -m "chore: update Hyperlane deps to SDK ${{ steps.get-versions.outputs.sdk }} and Utils ${{ steps.get-versions.outputs.utils }}

          - Update @hyperlane-xyz/sdk to ${{ steps.get-versions.outputs.sdk }}
          - Update @hyperlane-xyz/utils to ${{ steps.get-versions.outputs.utils }}
          - Update yarn.lock
          - Add changeset for dependency updates"

            git push -fu origin ci/update-hl-deps

            PR_TITLE="chore: update Hyperlane SDK and Utils to latest versions"
            PR_BODY="## Automated Dependency Update

          This PR updates the Hyperlane dependencies to their latest versions.

          **Updated versions:**
          - \`@hyperlane-xyz/sdk\`: \`${{ steps.get-versions.outputs.sdk }}\`
          - \`@hyperlane-xyz/utils\`: \`${{ steps.get-versions.outputs.utils }}\`

          **Changes include:**
          - Updated \`package.json\` with latest SDK and Utils versions
          - Updated \`yarn.lock\` via \`yarn install\`
          - Added changeset for dependency updates
          - Verified build passes with new versions
          - Verified unit tests pass with new versions

          ---
          ðŸ¤– This PR was automatically generated by the [update-hyperlane-deps workflow](.github/workflows/update-hyperlane-deps.yml)"

            PR_NUMBER=$(gh pr list --base main --head ci/update-hl-deps --json number --jq '.[0].number // empty')
            if [ -z "$PR_NUMBER" ]; then
              echo "Creating new PR..."
              gh pr create \
                --base main \
                --head ci/update-hl-deps \
                --title "$PR_TITLE" \
                --body "$PR_BODY"
            else
              echo "PR #$PR_NUMBER already exists. Updating title and description..."
              gh pr edit "$PR_NUMBER" \
                --title "$PR_TITLE" \
                --body "$PR_BODY"
            fi
          else
            echo "No changes detected. Skipping PR creation."
          fi
